
-- Wait for game and essentials to load (Solara/first-exec fix)
repeat wait() until game:IsLoaded()
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- Wait for Remotes
local Remotes = nil
repeat
    Remotes = ReplicatedStorage:FindFirstChild("Remotes")
    wait(0.2)
until Remotes

-- Wait for character
if not LocalPlayer.Character or not LocalPlayer.Character.Parent then
    LocalPlayer.CharacterAdded:Wait()
end

local Fluent = loadstring(game:HttpGet("https://raw.githubusercontent.com/jacklebeignet/Fluent-Reborn/refs/heads/main/src/ui.lua"))()  -- Patched Fluent for 2025 stability
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Remotes = ReplicatedStorage:WaitForChild("Remotes", 10)
if not Remotes then return Fluent:Notify({Title = "Error", Content = "Remotes not found—game loaded? Rejoin.", Duration = 5}) end

-- Window Setup
local Window = Fluent:CreateWindow({
    Title = "CHITO " .. (Fluent.Version or "v1.1"),
    SubTitle = "by onlyoneflaw (Fixed Dec '25)",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Spin = Window:AddTab({ Title = "Spin", Icon = "rotate-ccw" }),
    Tweaks = Window:AddTab({ Title = "Tweaks", Icon = "sliders" }),
    Abuse = Window:AddTab({ Title = "ABUSE", Icon = "alert-triangle" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- ========================
--    UTILS & CONNECTIONS
-- ========================

local Connections = {}
local function AddConnection(connection, name)
    if Connections[name] then Connections[name]:Disconnect() end
    Connections[name] = connection
end

local function DisconnectAll()
    for _, conn in pairs(Connections) do
        if conn and conn.Connected then conn:Disconnect() end
    end
    Connections = {}
end

LocalPlayer.CharacterRemoving:Connect(DisconnectAll)  -- Cleanup on death/respawn

-- ========================
--  MAIN TAB - Player Highlight + Damage + KO
-- ========================

local SelectedPlayer = nil
local HighlightInstance = nil

local function UpdatePlayerList()
    local names = {}
    for _, plr in Players:GetPlayers() do
        if plr ~= LocalPlayer and plr.Parent then
            table.insert(names, plr.Name)
        end
    end
    if Options.PlayerDropdown then
        Options.PlayerDropdown:SetValues(names)
    end
end

local function UpdateHighlight()
    if HighlightInstance then
        pcall(function() HighlightInstance:Destroy() end)
        HighlightInstance = nil
    end

    if not Options.EnableHighlightToggle or not Options.EnableHighlightToggle.Value or not SelectedPlayer or not SelectedPlayer.Character or not SelectedPlayer.Character.Parent then
        return
    end

    pcall(function()
        HighlightInstance = Instance.new("Highlight")
        HighlightInstance.Adornee = SelectedPlayer.Character
        HighlightInstance.FillColor = Color3.fromRGB(255, 0, 0)
        HighlightInstance.OutlineColor = Color3.new(0, 0, 0)
        HighlightInstance.FillTransparency = 0.5
        HighlightInstance.OutlineTransparency = 0
        HighlightInstance.Parent = SelectedPlayer.Character
    end)
end

Tabs.Main:AddToggle("EnableHighlightToggle", {
    Title = "Enable Highlight",
    Description = "Highlight selected player",
    Default = true,
    Callback = UpdateHighlight
})

local PlayerDropdown = Tabs.Main:AddDropdown("PlayerDropdown", {
    Title = "Select Player",
    Values = {},
    Multi = false,
    Default = 1,
    Callback = function(value)
        SelectedPlayer = Players:FindFirstChild(value)
        UpdateHighlight()
    end
})

Tabs.Main:AddSlider("DamageMultiplierSlider", {
    Title = "Damage Multiplier",
    Description = "Multiply outgoing damage (1-10)",
    Min = 1,
    Max = 10,
    Default = 1,
    Rounding = 0
})

-- Damage hook (robust, runs once, handles arg shifts from Dec patch)
if not getgenv().CHITO_DAMAGE_HOOKED then
    getgenv().CHITO_DAMAGE_HOOKED = true
    local mt = getrawmetatable(game)
    local old = mt.__namecall
    setreadonly(mt, false)
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        local args = {...}
        if method == "FireServer" and self.Name == "HitReport" and Remotes:FindFirstChild("HitReport") == self then
            local mult = Options.DamageMultiplierSlider and Options.DamageMultiplierSlider.Value or 1
            -- Target damage arg (usually [3], but check [2-4] for patch flexibility)
            for i = 2, 4 do
                if typeof(args[i]) == "number" and args[i] > 0 then
                    args[i] = args[i] * mult
                    break
                end
            end
            return old(self, unpack(args))
        end
        return old(self, ...)
    end)
    setreadonly(mt, true)
end

Tabs.Main:AddButton({
    Title = "Instant K.O",
    Description = "KO the selected player (updated args for Dec patch)",
    Callback = function()
        if not SelectedPlayer or not SelectedPlayer.Parent then
            Fluent:Notify({Title = "Error", Content = "No valid player selected!", Duration = 3})
            return
        end

        local hitRemote = Remotes:FindFirstChild("HitReport")
        if not hitRemote then
            Fluent:Notify({Title = "Error", Content = "HitReport remote missing—rejoin?", Duration = 3})
            return
        end

        pcall(function()
            hitRemote:FireServer(
                SelectedPlayer,
                "J",  -- Jab type
                60000,  -- High damage
                6,  -- Power
                "HEAD",
                Vector3.new(77.472, 13.265, -37.025),
                CFrame.new(77.487, 13.293, -37.228, -0.997443, -0.009605, 0.070818, 0, 0.990927, 0.134398, -0.071466, 0.134054, -0.988394),
                Vector3.new(0.6, 0.6, 0.41),
                tick() * 1000  -- Dynamic timestamp to avoid spam filters
            )
            Fluent:Notify({Title = "K.O Sent", Content = "Check if they're down!", Duration = 2})
        end)
    end
})

Tabs.Main:AddButton({
    Title = "Instant Get Up",
    Description = "Stand up instantly when knocked",
    Callback = function()
        local qteRemote = ReplicatedStorage:FindFirstChild("QTECompleteEvent")
        if not qteRemote then
            Fluent:Notify({Title = "Error", Content = "QTE remote missing!", Duration = 3})
            return
        end

        for i = 1, 9 do
            local ring = Workspace:FindFirstChild("Rings") and Workspace.Rings:FindFirstChild("Ring" .. i)
            if ring then
                pcall(function()
                    qteRemote:FireServer(ring, 8337479548, true)
                end)
            end
        end
        Fluent:Notify({Title = "Get Up", Content = "Spam sent—stand tall!", Duration = 2})
    end
})

-- Dynamic player list updates
Players.PlayerAdded:Connect(UpdatePlayerList)
Players.PlayerRemoving:Connect(UpdatePlayerList)
UpdatePlayerList()

-- ========================
--  TWEAKS TAB
-- ========================

-- Noclip (fixed loop to avoid char nil errors)
local NoclipEnabled = false
Tabs.Tweaks:AddToggle("NoclipToggle", {
    Title = "Noclip",
    Description = "Walk through walls",
    Default = false,
    Callback = function(state)
        NoclipEnabled = state
        if state then
            AddConnection(RunService.Stepped:Connect(function()
                pcall(function()
                    local char = LocalPlayer.Character
                    if char then
                        for _, part in char:GetDescendants() do
                            if part:IsA("BasePart") and part.CanCollide then
                                part.CanCollide = false
                            end
                        end
                    end
                end)
            end), "NoclipLoop")
        else
            if Connections.NoclipLoop then
                Connections.NoclipLoop:Disconnect()
                Connections.NoclipLoop = nil
            end
            pcall(function()
                local char = LocalPlayer.Character
                if char then
                    for _, part in char:GetDescendants() do
                        if part:IsA("BasePart") and part ~= char:FindFirstChild("HumanoidRootPart") then
                            part.CanCollide = true
                        end
                    end
                end
            end)
        end
        Fluent:Notify({Title = "Noclip", Content = state and "Enabled" or "Disabled", Duration = 2})
    end
})

-- Infinite Power (safer destroy)
Tabs.Tweaks:AddButton({
    Title = "Infinite Power",
    Description = "Removes power drain (irreversible til rejoin)",
    Callback = function()
        local powerRemote = Remotes:FindFirstChild("PowerReduce")
        if powerRemote then
            pcall(function() powerRemote:Destroy() end)
            Fluent:Notify({Title = "Infinite Power", Content = "Drain removed—go wild!", Duration = 4})
        else
            Fluent:Notify({Title = "Infinite Power", Content = "Already removed or not found.", Duration = 3})
        end
    end
})

-- Walkspeed (fixed enforce on slider change/respawn)
local function ApplyWalkspeed()
    if Connections.Walkspeed then
        Connections.Walkspeed:Disconnect()
    end
    local speed = Options.WalkspeedSlider and Options.WalkspeedSlider.Value or 16
    AddConnection(RunService.Heartbeat:Connect(function()
        pcall(function()
            local char = LocalPlayer.Character
            if char then
                local hum = char:FindFirstChildOfClass("Humanoid")
                if hum and hum.WalkSpeed ~= speed then
                    hum.WalkSpeed = speed
                end
            end
        end)
    end), "Walkspeed")
end

Tabs.Tweaks:AddSlider("WalkspeedSlider", {
    Title = "Walkspeed",
    Description = "Enforced walkspeed",
    Min = 0,
    Max = 200,
    Default = 16,
    Rounding = 0,
    Callback = ApplyWalkspeed
})

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)  -- Wait for full load
    ApplyWalkspeed()
end)
if LocalPlayer.Character then ApplyWalkspeed() end

-- ========================
--  ABUSE TAB - Become Robot (fixed pathing/teleport spam)
-- ========================

Tabs.Abuse:AddButton({
    Title = "BECOME ROBOT",
    Description = "Training ring must be empty! Wait 10s, don't move.",
    Callback = function()
        Fluent:Notify({
            Title = "BECOME ROBOT",
            Content = "Hold still for 10s—process starting...",
            Duration = 6
        })

        task.spawn(function()
            local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            local hrp = char:WaitForChild("HumanoidRootPart", 5)

            -- Step 1: Touch ring (chained findFirstChild for safety)
            task.wait(2)
            Fluent:Notify({Title = "1/5", Content = "Entering training ring..."})
            local rings = Workspace:FindFirstChild("Rings")
            local touch = rings and rings:FindFirstChild("TrainingRing") and rings.TrainingRing:FindFirstChild("Zones") and rings.TrainingRing.Zones:FindFirstChild("P1Touch") and rings.TrainingRing.Zones.P1Touch:FindFirstChild("Touch1")
            if touch and hrp then
                firetouchinterest(hrp, touch, 0)
                task.wait(0.1)
                firetouchinterest(hrp, touch, 1)
            end

            -- Step 2: Toggle state (pcall wrapped)
            task.wait(2)
            Fluent:Notify({Title = "2/5", Content = "Hacking game state..."})
            pcall(function() LocalPlayer:SetAttribute("InGameState", false) end)
            task.wait(0.1)
            pcall(function() LocalPlayer:SetAttribute("InGameState", true) end)

            -- Step 3: Teleport spam (shorter loop, dynamic CFrame)
            task.wait(2)
            Fluent:Notify({Title = "3/5", Content = "Forcing robot teleport..."})
            local targetCFrame = CFrame.new(-15, 4, 6)
            for i = 1, 30 do  -- Reduced for less lag
                pcall(function() if hrp then hrp.CFrame = targetCFrame end end)
                task.wait(0.07)
            end

            -- Step 4: Camera fix (per-frame reset)
            task.wait(2)
            Fluent:Notify({Title = "4/5", Content = "Stabilizing camera..."})
            if not getgenv().RobotCamFix then
                getgenv().RobotCamFix = RunService.RenderStepped:Connect(function()
                    pcall(function()
                        local cam = Workspace.CurrentCamera
                        local hum = char:FindFirstChildOfClass("Humanoid")
                        if hum and cam then
                            cam.CameraSubject = hum
                            cam.CameraType = Enum.CameraType.Custom
                            cam.FieldOfView = 70
                        end
                    end)
                end)
            end

            -- Success
            task.wait(2)
            Fluent:Notify({Title = "5/5 - SUCCESS", Content = "Robot mode activated! Test in ring.", Duration = 6})
        end)
    end
})

-- ========================
--  SPIN TAB - Auto Spin (fixed invoke order/cooldown)
-- ========================

local BotList = {"AMBUSH", "FATBOY", "ATOM", "MIDAS", "GAMBIT", "AQUABOT", "DANGER ZONE"}

local DesiredBotDropdown = Tabs.Spin:AddDropdown("DesiredBotDropdown", {
    Title = "Desired Bot",
    Values = BotList,
    Multi = false,
    Default = "GAMBIT"
})

local Spinning = false
Tabs.Spin:AddToggle("AutoSpinToggle", {
    Title = "Auto Spin (FREE)",
    Description = "Spins until desired bot (0.2s delay for cooldown)",
    Default = false,
    Callback = function(state)
        Spinning = state
        if not state then return end

        task.spawn(function()
            local spinRemote = Remotes:FindFirstChild("RequestSpinResult")
            local getBotRemote = Remotes:FindFirstChild("GetCurrentBot")
            if not spinRemote or not getBotRemote then
                Fluent:Notify({Title = "Error", Content = "Spin remotes missing—rejoin?", Duration = 3})
                Options.AutoSpinToggle:SetValue(false)
                return
            end

            while Spinning do
                pcall(function()
                    spinRemote:InvokeServer()  -- Spin first
                    task.wait(0.2)  -- Cooldown buffer (tuned for Dec patch)
                    local currentBot = getBotRemote:InvokeServer()

                    local notifContent = "Rolled: " .. tostring(currentBot)
                    if currentBot == DesiredBotDropdown.Value then
                        notifContent = notifContent .. " - GOT IT! Reopen shop."
                        Fluent:Notify({Title = "WINNER!", Content = notifContent, Duration = 5})
                        Spinning = false
                        Options.AutoSpinToggle:SetValue(false)
                    else
                        notifContent = notifContent .. " - Keep spinning..."
                        Fluent:Notify({Title = "Spin Result", Content = notifContent, Duration = 1})
                    end
                end)
                if Spinning then task.wait(0.1) end
            end
        end)
    end
})

-- ========================
--  FINAL SETUP
-- ========================

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("ChitoHub")
SaveManager:SetFolder("ChitoHub/untitledrobotboxing")

InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)  -- Fixed: Added this for config saving

Window:SelectTab(1)

Fluent:Notify({
    Title = "CHITO Hub (Fixed)",
    Content = "All functions restored—happy exploiting! Report bugs if any.",
    Duration = 5
})

SaveManager:LoadAutoloadConfig()
